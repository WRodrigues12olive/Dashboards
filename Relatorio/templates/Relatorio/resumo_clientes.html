<!DOCTYPE html>
{% load format_helpers %}
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumo Clientes</title> {# Título da aba simplificado #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chart-container { height: 400px;  width: 650px; }
        .table th, .table td {
            white-space: nowrap;
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        .filter-form {
            margin-bottom: 1.5rem;
        }
        .side-chart-container {
            height: 140px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
         .card-body {
        padding: 0.30rem !important; /* antes era p-3 */
        }

        @media (min-width: 992px) {
            .col-lg-4.col-xl-4 {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                height: 100%;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid mt-4">

        <form method="GET" action="{% url 'resumo_clientes' %}" class="row gx-2 gy-2 align-items-center filter-form">
            <div class="col-auto">
                <label for="start_date" class="visually-hidden">De</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">De</span>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                </div>
            </div>
            <div class="col-auto">
                <label for="end_date" class="visually-hidden">Até</label>
                 <div class="input-group input-group-sm">
                    <span class="input-group-text">Até</span>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                 </div>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            </div>
        </form>

        <div class="row">
            <div class="col-lg-9 col-xl-8">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Total OS</th>
                                        <th>Concluídas</th>
                                        <th>Em Processo</th>
                                        <th>Em Verificação</th>
                                        <th>Canceladas</th>
                                        <th>Tempo Médio Atendimento</th>
                                        <th>SLA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in data_resumo %}
                                    <tr>
                                        <td>{{ item.cliente }}</td>
                                        <td>{{ item.total_os }}</td>
                                        <td>{{ item.concluidas }}</td>
                                        <td>{{ item.em_processo }}</td>
                                        <td>{{ item.em_verificacao }}</td>
                                        <td>{{ item.canceladas }}</td>
                                        <td>
                                            {{ item.tempo_medio_atendimento|format_timedelta }}
                                        </td>
                                        <td>{{ item.sla_status }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">Nenhum dado encontrado.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="chart-container history-chart-container">
                    <h5>OS Criadas por Mês (Histórico Geral)</h5>
                    <canvas id="osPorMesResumoChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4 col-xl-4 d-flex flex-column justify-content-between">
        <!-- Gráfico Tipo de Tarefa -->
                <div class="card flex-fill mb-3">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center p-3">
                        <h6 class="text-center mb-2">Tipo de Tarefa</h6>
                            <div class="chart-container side-chart-container w-100 d-flex justify-content-center">
                                <canvas id="tipoTarefaResumoChart"></canvas>
                            </div>
                    </div>
                </div>

        <!-- Gráfico Origem da OS -->
                <div class="card flex-fill">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center p-3">
                        <h6 class="text-center mb-2">Origem da OS (Ticket)</h6>
                            <div class="chart-container side-chart-container w-100 d-flex justify-content-center">
                                <canvas id="origemOsResumoChart"></canvas>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div> {# Fim do container principal #}
    {# Scripts JavaScript #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    {{ mes_labels|json_script:"mes_labels" }}
    {{ mes_data|json_script:"mes_data" }}
    {{ ticket_labels_periodo|json_script:"ticket_labels_periodo" }}
    {{ ticket_data_periodo|json_script:"ticket_data_periodo" }}
    {{ tipo_tarefa_grupo_labels_periodo|json_script:"tipo_tarefa_grupo_labels_periodo" }}
    {{ tipo_tarefa_grupo_data_periodo|json_script:"tipo_tarefa_grupo_data_periodo" }}

    <script>
        Chart.register(ChartDataLabels); // Registra plugin para labels nos gráficos
        const getDjangoData = (id) => JSON.parse(document.getElementById(id).textContent); // Função helper

        // Código JavaScript para criar o novo gráfico de linha
        new Chart(document.getElementById('osPorMesResumoChart'), {
            type: 'line',
            data: {
                labels: getDjangoData('mes_labels'),
                datasets: [{
                    label: 'Nº de OS Criadas',
                    data: getDjangoData('mes_data'),
                    borderColor: '#fd7e14',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    datalabels: { display: false }
                },
                 scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        new Chart(document.getElementById('tipoTarefaResumoChart'), {
            type: 'pie',
            data: {
                labels: getDjangoData('tipo_tarefa_grupo_labels_periodo'),
                datasets: [{
                    label: 'Total de OS',
                    data: getDjangoData('tipo_tarefa_grupo_data_periodo'),
                     backgroundColor: ['#0d6efd', '#ffc107', '#fd7e14', '#6f42c1', '#20c997', '#dc3545', '#6c757d', '#0dcaf0', '#d63384', '#adb5bd', '#ffca2c', '#6610f2'],
                }]
            },
            options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: {
                    datalabels: { color: '#fff', font: { weight: 'bold', size: 10 } },
                    legend: { display: true, position: 'right', align: 'bottom' } // Mostra legenda
                 }
            }
        });
        new Chart(document.getElementById('origemOsResumoChart'), {
            type: 'bar',
            data: {
                labels: getDjangoData('ticket_labels_periodo'),
                datasets: [{
                    label: 'Total de OS',
                    data: getDjangoData('ticket_data_periodo'),
                    backgroundColor: ['#dc3545', '#28a745'], // Cores Sim/Não
                }]
            },
             options: {
                 indexAxis: 'y',
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: {
                     datalabels: { color: '#fff', font: { weight: 'bold', size: 10 } },
                     legend: { display: true, position: 'top' } // Mostra legenda
                }
            }
        });
    </script>
</body>
</html>