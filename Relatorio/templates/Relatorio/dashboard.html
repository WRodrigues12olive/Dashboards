<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Relatórios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .chart-container, .report-container { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .chart-container { height: 400px; }
        #osPorLocalChartContainer { height: 700px; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Dashboard de Relatórios de OS</h1>
            <div class="d-flex flex-column align-items-end">
                <form method="GET" action="" class="d-flex align-items-center mb-2">
                    <div class="me-2">
                        <label for="local_grupo" class="form-label mb-0">Local/Cliente</label>
                        <select id="local_grupo" name="local_grupo" class="form-select">
                            {% for grupo in grupos_de_local_disponiveis %}
                                <option value="{{ grupo }}" {% if grupo == selected_local %}selected{% endif %}>{{ grupo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="me-2"><label for="start_date" class="form-label mb-0">De</label><input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}"></div>
                    <div class="me-2"><label for="end_date" class="form-label mb-0">Até</label><input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}"></div>
                    <button type="submit" class="btn btn-primary align-self-end me-2">Filtrar</button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary align-self-end">Limpar</a>
                </form>
                <a href="{% url 'extracao_relatorios' %}" class="btn btn-outline-success">Extrair Relatórios</a>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-3 row-cols-xl-5 g-4 mb-4">
            <div class="col"><div class="card text-white bg-primary h-100"><div class="card-header">{% if start_date or selected_local != 'Todos' %} OS no Período {% else %} Total de OS {% endif %}</div><div class="card-body"><h2 class="card-title">{{ os_abertas_no_periodo }}</h2></div></div></div>
            <div class="col"><div class="card text-white bg-info h-100"><div class="card-header">OS Em Processo</div><div class="card-body"><h2 class="card-title">{{ os_em_processo }}</h2></div></div></div>
            <div class="col"><div class="card text-white bg-warning h-100"><div class="card-header">OS Em Verificação</div><div class="card-body"><h2 class="card-title">{{ os_em_verificacao }}</h2></div></div></div>
            <div class="col"><div class="card text-white h-100" style="background-color: #28a745"><div class="card-header">OS Concluídas</div><div class="card-body"><h2 class="card-title">{{ os_concluidas }}</h2></div></div></div>
            <div class="col"><div class="card text-white bg-danger h-100"><div class="card-header">OS Canceladas</div><div class="card-body"><h2 class="card-title">{{ os_canceladas }}</h2></div></div></div>
        </div>

        <div class="row">
            <div class="col-xl-6 mb-4"><div class="chart-container"><h5>Ordens de Serviço por Status</h5><canvas id="osPorStatusChart"></canvas></div></div>
            <div class="col-xl-6 mb-4"><div class="chart-container"><h5>Ordens de Serviço por Criticidade</h5><canvas id="osPorCriticidadeChart"></canvas></div></div>
        </div>
        <div class="row">
            <div class="col-xl-4 mb-4"><div class="chart-container"><h5>OS Criadas por Mês (Histórico)</h5><canvas id="osPorMesChart"></canvas></div></div>
            <div class="col-xl-4 mb-4"><div class="chart-container"><h5>Origem de OS (Via Ticket)</h5><canvas id="osPorTicketChart"></canvas></div></div>
            <div class="col-xl-4 mb-4"><div class="chart-container"><h5>Tipo de Tarefa (no período)</h5><canvas id="tarefaPorGrupoChart"></canvas></div></div>
        </div>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="report-container">
                    <h5>Ocorrências por Local/Cliente (no período)</h5>
                    <div id="osPorLocalChartContainer" class="chart-container"><canvas id="osPorLocalChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- STATUS DE EXECUÇÃO -->
        <div class="row">
            <div class="col-lg-6 col-xl-3 mb-4">
                <div class="report-container">
                    <h5>Status de Execução da OS</h5>
                    <div class="chart-container"><canvas id="execucaoStatusChart"></canvas></div>
                </div>
            </div>
            <!-- SLAs -->
            <div class="col-lg-6 col-xl-3 mb-4">
                <div class="report-container">
                    <h5>SLA de Atendimento (Gerdau)</h5>
                    <div class="chart-container" style="padding-bottom: 50px;"><canvas id="slaAtendimentoChart"></canvas></div>
                    <div class="text-center mt-2">
                        <small>Ver OS não atendidas:</small>
                        <a href="{% url 'sla_violado_lista' 'C0' %}" class="btn btn-outline-danger btn-sm">C0 (3h)</a>
                        <a href="{% url 'sla_violado_lista' 'C1' %}" class="btn btn-outline-danger btn-sm">C1 (12h)</a>
                        <a href="{% url 'sla_violado_lista' 'C2' %}" class="btn btn-outline-danger btn-sm">C2 (24h)</a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-xl-3 mb-4">
                <div class="report-container">
                    <h5>SLA de Resolução (Gerdau)</h5>
                    <div class="chart-container" style="padding-bottom: 50px;"><canvas id="slaResolucaoChart"></canvas></div>
                    <div class="text-center mt-2">
                        <small>Ver OS não atendidas:</small>
                        <a href="{% url 'sla_resolucao_violado_lista' 'C0' %}" class="btn btn-outline-danger btn-sm">C0 (8h)</a>
                        <a href="{% url 'sla_resolucao_violado_lista' 'C1' %}" class="btn btn-outline-danger btn-sm">C1 (24h)</a>
                        <a href="{% url 'sla_resolucao_violado_lista' 'C2' %}" class="btn btn-outline-danger btn-sm">C2 (48h)</a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-xl-3 mb-4">
                <div class="report-container">
                    <h5>SLA de Resolução (Park Shopping)</h5>
                    <div class="chart-container" style="padding-bottom: 50px;"><canvas id="slaParkShoppingChart"></canvas></div>
                    <div class="text-center mt-2">
                        <small>Ver OS não atendidas:</small>
                        <a href="{% url 'sla_parkshopping_violado_lista' %}" class="btn btn-outline-danger btn-sm">SLA 24h</a>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-xl-3 mb-4">
                <div class="report-container">
                    <h5>SLA de Resolução (CPFL)</h5>
                    <div class="chart-container" style="padding-bottom: 50px;"><canvas id="slacpflChart"></canvas></div>
                    <div class="text-center mt-2">
                        <small>Ver OS não atendidas:</small>
                        <a href="{% url 'sla_cpfl_violado_lista' %}" class="btn btn-outline-danger btn-sm">SLA 72h</a>
                    </div>
                </div>
            </div>
        </div>
    <!-- VOLUME DE OS POR SEMANA -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="report-container">
                    <form method="GET" class="row g-3 align-items-center mb-3">
                        <div class="col-auto"><h5>Volume de OS por Semana no Ano</h5></div>
                        <div class="col-md-3"><select name="selected_year_weekly" class="form-select"><option value="">Selecione um ano</option>{% for ano in anos_disponiveis %}<option value="{{ ano }}" {% if ano == selected_year_weekly %}selected{% endif %}>{{ ano }}</option>{% endfor %}</select></div>
                        <div class="col-md-2"><button type="submit" class="btn btn-outline-primary">Gerar Gráfico</button></div>
                    </form>
                    {% if selected_year_weekly %}<div class="chart-container"><canvas id="weeklyOsChart"></canvas></div>{% else %}<div class="alert alert-light text-center" role="alert">Selecione um ano para gerar o gráfico.</div>{% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    {{ status_labels|json_script:"status_labels" }}
    {{ status_data|json_script:"status_data" }}
    {{ criticidade_labels|json_script:"criticidade_labels" }}
    {{ criticidade_data|json_script:"criticidade_data" }}
    {{ mes_labels|json_script:"mes_labels" }}
    {{ mes_data|json_script:"mes_data" }}
    {{ ticket_labels|json_script:"ticket_labels" }}
    {{ ticket_data|json_script:"ticket_data" }}
    {{ execucao_status_labels|json_script:"execucao_status_labels" }}
    {{ execucao_status_data|json_script:"execucao_status_data" }}
    {{ local_agrupado_labels|json_script:"local_agrupado_labels" }}
    {{ local_agrupado_data|json_script:"local_agrupado_data" }}
    {{ tarefa_grupo_labels|json_script:"tarefa_grupo_labels" }}
    {{ tarefa_grupo_data|json_script:"tarefa_grupo_data" }}
    {{ weekly_labels|json_script:"weekly_labels" }}
    {{ weekly_data_points|json_script:"weekly_data_points" }}
    {{ sla_atendimento_c0_data|json_script:"sla_atendimento_c0_data" }}
    {{ sla_atendimento_c1_data|json_script:"sla_atendimento_c1_data" }}
    {{ sla_atendimento_c2_data|json_script:"sla_atendimento_c2_data" }}
    {{ sla_resolucao_c0_data|json_script:"sla_resolucao_c0_data" }}
    {{ sla_resolucao_c1_data|json_script:"sla_resolucao_c1_data" }}
    {{ sla_resolucao_c2_data|json_script:"sla_resolucao_c2_data" }}
    {{ sla_parkshopping_data|json_script:"sla_parkshopping_data" }}
    {{ sla_cpfl_data|json_script:"sla_cpfl_data" }}

    <script>
        Chart.register(ChartDataLabels);
        const getDjangoData = (id) => JSON.parse(document.getElementById(id).textContent);

        new Chart(document.getElementById('osPorLocalChart'), { type: 'bar', data: { labels: getDjangoData('local_agrupado_labels'), datasets: [{ label: 'Total de OS', data: getDjangoData('local_agrupado_data'), backgroundColor: '#0d6efd', }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, layout: { padding: { left: 150 } }, scales: { y: { ticks: { font: { size: 10 } } } }, plugins: { datalabels: { anchor: 'end', align: 'end', color: '#343a40', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('osPorStatusChart'), { type: 'pie', data: { labels: getDjangoData('status_labels'), datasets: [{ label: 'Total de OS', data: getDjangoData('status_data'), backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('osPorCriticidadeChart'), { type: 'bar', data: { labels: getDjangoData('criticidade_labels'), datasets: [{ label: 'Total de OS', data: getDjangoData('criticidade_data'), backgroundColor: '#0d6efd', }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { anchor: 'end', align: 'top', color: '#495057', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('osPorMesChart'), { type: 'line', data: { labels: getDjangoData('mes_labels'), datasets: [{ label: 'Nº de OS Criadas', data: getDjangoData('mes_data'), borderColor: '#fd7e14', tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } } });
        new Chart(document.getElementById('osPorTicketChart'), { type: 'doughnut', data: { labels: getDjangoData('ticket_labels'), datasets: [{ label: 'Total de OS', data: getDjangoData('ticket_data'), backgroundColor: ['#dc3545', '#28a745'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('tarefaPorGrupoChart'), { type: 'pie', data: { labels: getDjangoData('tarefa_grupo_labels'), datasets: [{label: 'Total de Tarefas', data: getDjangoData('tarefa_grupo_data'), backgroundColor: ['#0d6efd','6f42c1', '#dc3545', '#17a2b8', '#6c757d', '#ffc107'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' } } } }});
        
        // --- GRÁFICOS MENORES RESTAURADOS E CORRIGIDOS ---
        new Chart(document.getElementById('execucaoStatusChart'), { type: 'doughnut', data: { labels: getDjangoData('execucao_status_labels'), datasets: [{ label: 'Contagem de OS', data: getDjangoData('execucao_status_data'), backgroundColor: ['#0d6efd', '#fd7e14', '#6c757d'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('slaAtendimentoChart'), { type: 'bar', data: { labels: ['C0 (3h)', 'C1 (12h)', 'C2 (24h)'], datasets: [ { label: 'SLA Atendido', data: [getDjangoData('sla_atendimento_c0_data').atendido, getDjangoData('sla_atendimento_c1_data').atendido, getDjangoData('sla_atendimento_c2_data').atendido], backgroundColor: '#28a745' }, { label: 'SLA Não Atendido', data: [getDjangoData('sla_atendimento_c0_data').nao_atendido, getDjangoData('sla_atendimento_c1_data').nao_atendido, getDjangoData('sla_atendimento_c2_data').nao_atendido], backgroundColor: '#DC3545' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: 'white', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('slaResolucaoChart'), { type: 'bar', data: { labels: ['C0 (8h)', 'C1 (24h)', 'C2 (48h)'], datasets: [ { label: 'SLA Atendido', data: [getDjangoData('sla_resolucao_c0_data').atendido, getDjangoData('sla_resolucao_c1_data').atendido, getDjangoData('sla_resolucao_c2_data').atendido], backgroundColor: '#28a745' }, { label: 'SLA Não Atendido', data: [getDjangoData('sla_resolucao_c0_data').nao_atendido, getDjangoData('sla_resolucao_c1_data').nao_atendido, getDjangoData('sla_resolucao_c2_data').nao_atendido], backgroundColor: '#DC3545' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: 'white', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('slaParkShoppingChart'), { type: 'bar', data: { labels: ['SLA 24h'], datasets: [ { label: 'SLA Atendido', data: [getDjangoData('sla_parkshopping_data').atendido], backgroundColor: '#28a745' }, { label: 'SLA Não Atendido', data: [getDjangoData('sla_parkshopping_data').nao_atendido], backgroundColor: '#DC3545' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: 'white', font: { weight: 'bold' } } } } });
        new Chart(document.getElementById('slacpflChart'), { type: 'bar', data: { labels: ['SLA 72h'], datasets: [ { label: 'SLA Atendido', data: [getDjangoData('sla_cpfl_data').atendido], backgroundColor: '#28a745' }, { label: 'SLA Não Atendido', data: [getDjangoData('sla_cpfl_data').nao_atendido], backgroundColor: '#DC3545' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: 'white', font: { weight: 'bold' } } } } });

        const weeklyChartCanvas = document.getElementById('weeklyOsChart');
        if (weeklyChartCanvas) { new Chart(weeklyChartCanvas, { type: 'line', data: { labels: getDjangoData('weekly_labels'), datasets: [{ label: 'Nº de OS Criadas na Semana', data: getDjangoData('weekly_data_points'), borderColor: '#20c997', backgroundColor: 'rgba(32, 201, 151, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } } }); }
    </script>
</body>
</html>